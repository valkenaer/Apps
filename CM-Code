Import-Module $env:SMS_ADMIN_UI_PATH.Replace("\bin\i386","\bin\configurationmanager.psd1")
$SiteCode = Get-PSDrive -PSProvider CMSITE
Set-Location "$($SiteCode.Name):\"
 
          $SiteServer = $Env:COMPUTERNAME
             $DPGName = "BSC_DPG"

$Manu = "Microsoft"
$AppName = "VSCode"
$ProcName = "code.exe"
$AppDesc = "Visual Studio Code is a lightweight but powerful source code editor which runs on your desktop and is available for Windows, macOS and Linux."

                                  $ExpectedVersion = "1.107.1"
                                     $VerMINUSONE  = "1.107.0"

$PrevVersion = "Microsoft VSCode $VerMINUSONE"
$ExeLocation = "\\$SiteServer\Sources$\Applications\Microsoft\VSCode\$ExpectedVersion"
$InstStr = "VSCodeSetup-x64-$ExpectedVersion.exe /VERYSILENT /NORESTART"
$UninstStr = "`"C:\Program Files\Microsoft VS Code\unins000.exe`" /VERYSILENT /NORESTART"
$HKLMKey = "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\{EA457B21-F73E-494C-ACAB-524FDE069978}_is1"
$DTName = "VSCode deployment"
$DGName = "BSC_DPG"
$Purp = "Required"
$DevColl = "W1XV2XH2 - 20250613 - ITS - P04_65"
$AppFullName = "$Manu $AppName $ExpectedVersion"
$ConsoleFolderPath = "\Applications\Microsoft"

If (Get-CMApplication $PrevVersion) {
           Remove-CMApplicationDeployment -Name $PrevVersion -CollectionName $DevColl -Force
           Remove-CMApplication $PrevVersion -Force
}


$clause1 = New-CMDetectionClauseRegistryKeyValue -Hive LocalMachine -KeyName $HKLMKey -ValueName "DisplayVersion" -PropertyType String -ExpressionOperator IsEquals -ExpectedValue $ExpectedVersion -Value

New-CMApplication -Name $AppFullName -Description $AppDesc -Publisher $Manu -SoftwareVersion $ExpectedVersion 
Add-CMScriptDeploymentType -ContentLocation $ExeLocation -ApplicationName $AppFullname -DeploymentTypeName $DTName -InstallCommand $InstStr -UninstallCommand $UninstStr -AddDetectionClause $clause1 -MaximumRuntimeMins 20 -InstallationBehaviorType InstallForSystem -UserInterActionMode Hidden

$msi_dt = Get-CMDeploymentType -ApplicationName $AppFullName -DeploymentTypeName $DTName
Add-CMDeploymentTypeInstallBehavior -InputObject $msi_dt -ExeFileName $ProcName -DisplayName "Running image name"

Start-CMContentDistribution -ApplicationName $AppFullName -DistributionPointGroupName $DGName
New-CMApplicationDeployment -CollectionName $DevColl -Name $AppFullName -DeployAction Install -DeployPurpose $Purp -UserNotification DisplayAll -OverrideServiceWindow $true -AvailableDateTime (get-date) -AutoCloseExecutable $true -TimeBaseOn LocalTime -Verbose

$MoveApp = Get-CMApplication -Name $AppFullName

If($ConsoleFolderPath) {
    $MoveApp | Move-CMObject -FolderPath "$($SiteCode):\Application$($ConsoleFolderPath)"
}




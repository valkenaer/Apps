Import-Module $env:SMS_ADMIN_UI_PATH.Replace("\bin\i386","\bin\configurationmanager.psd1")
$SiteCode = Get-PSDrive -PSProvider CMSITE
Set-Location "$($SiteCode.Name):\"
 
     $SiteServer = $Env:COMPUTERNAME
    
    $AppVer      = "7.5.4"
    $VerMinOne   = "7.5.0"

$MSILocation     = "\\$SiteServer\Sources$\Applications\Microsoft\PowerShell\$AppVer\PowerShell-$AppVer-win-x64.msi"
$AppName         = "Powershell"

$Manu            = "Microsoft"
$AppDesc         = "PowerShell $AppVer is Microsoft's latest version of Windows task automation framework"
$Purp            = "Required"
$DPGName         = "BSC_DPG"
$AppFullName     = "$Manu $AppName $AppVer"
$PrevVersion     = "$Manu $AppName $VerMinOne"
$ConsoleFolderPath = "\Applications\Microsoft"

   $DevColl01         = "BSC-P Beheer VDI's"
   $DevColl02         = "BSC-P SOC Beheer VDI's"
   $DevColl03         = "All Computer With Windows Server **"


If (Get-CMApplication $PrevVersion) {

    Remove-CMApplicationDeployment -Name $PrevVersion -CollectionName $DevColl01 -Force
    Remove-CMApplicationDeployment -Name $PrevVersion -CollectionName $DevColl02 -Force
    Remove-CMApplicationDeployment -Name $PrevVersion -CollectionName $DevColl03 -Force
    Remove-CMApplication $PrevVersion -Force

}

New-CMApplication -Name $AppFullName -Description $AppDesc -Publisher $Manu -SoftwareVersion $ExpectedVersion 
Add-CMMSIDeploymentType -ApplicationName $AppFullname -ContentLocation $MSILocation -InstallationBehaviorType InstallForSystem -Force -UserInterActionMode Hidden
Start-CMContentDistribution -ApplicationName $AppFullName -DistributionPointGroupName $DPGName

New-CMApplicationDeployment -CollectionName $DevColl01 -Name $AppFullName -DeployAction Install -DeployPurpose $Purp -UserNotification HideAll -AvailableDateTime (get-date) -TimeBaseOn LocalTime -Verbose
New-CMApplicationDeployment -CollectionName $DevColl02 -Name $AppFullName -DeployAction Install -DeployPurpose $Purp -UserNotification HideAll -AvailableDateTime (get-date) -TimeBaseOn LocalTime -Verbose
New-CMApplicationDeployment -CollectionName $DevColl03 -Name $AppFullName -DeployAction Install -DeployPurpose $Purp -UserNotification HideAll -AvailableDateTime (get-date) -TimeBaseOn LocalTime -Verbose

$MoveApp = Get-CMApplication -Name $AppFullName

If($ConsoleFolderPath) {
    $MoveApp | Move-CMObject -FolderPath "$($SiteCode):\Application$($ConsoleFolderPath)"
}




